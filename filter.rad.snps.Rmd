---
title: "Hipposideros.rad.filtering"
author: "Devon DeRaad"
date: "5/3/2022"
output: html_document
---

# SNPfiltR quality filtering pipeline
### Read in your unfiltered vcf file
```{r setup, echo = T, results = 'hide'}
library(vcfR)
library(ggplot2)
library(gridExtra)
library(ggridges)
library(adegenet)
library(SNPfiltR)
library(dplyr)

#read in vcf as vcfR
vcfR <- read.vcfR("~/Desktop/hipposideros/n3.vcf")
### check the metadata present in your vcf
vcfR
vcfR@fix[1:10,1:8]
vcfR@gt[1:10,1:2]

#read in sample metadata
samps<-read.csv("~/Desktop/hipposideros/hipposideros.sampling.csv")
#retain samples that were sequenced successfully
samps<-samps[samps$id %in% colnames(vcfR@gt),]
samps$id == colnames(vcfR@gt)[-1] #check that order matches

#generate popmap file. Two column popmap with the same format as stacks, and the columns must be named 'id' and 'pop'
popmap<-data.frame(id=samps$id,
                   pop=paste(samps$species, samps$Island, sep = "_"))
table(popmap$pop)
```

## step 1: Implement quality filters that don't involve missing data. This is because removing low data samples will alter percentage/quantile based missing data cutoffs, so we wait to implement those until after deciding on our final set of samples for downstream analysis
```{r}
#hard filter to minimum depth of 3, and minimum genotype quality of 30
vcfR<-hard_filter(vcfR, depth = 3, gq = 30)
```

### Use this function to filter for allele balance
### from Puritz SNP filtering tutorial "Allele balance: a number between 0 and 1 representing the ratio of reads showing the reference allele to all reads, considering only reads from individuals called as heterozygous, we expect that the allele balance in our data (for real loci) should be close to 0.5"
```{r}
#execute allele balance filter
vcfR<-filter_allele_balance(vcfR)
```

### max depth filter (super high depth loci are likely multiple loci stuck together into a single paralogous locus).
```{r}
#visualize and pick appropriate max depth cutoff
max_depth(vcfR)

#filter vcf by the max depth cutoff you chose
vcfR<-max_depth(vcfR, maxdepth = 100)
```


```{r}
#check vcfR to see how many SNPs we have left
vcfR
```

## Step 2: visualize missing data by sample. Check out the visualizations and make decision on which samples to keep for downstream analysis.
```{r}
#run function to visualize samples
miss<-missing_by_sample(vcfR=vcfR)

#run function to drop samples above the threshold we want from the vcf
#setting it conservatively for now
vcfR<-missing_by_sample(vcfR=vcfR, cutoff = .9)

#subset popmap to only include retained individuals
popmap<-popmap[popmap$id %in% colnames(vcfR@gt),]

#alternatively, you can drop individuals from vcfR manually using the following syntax, if a strict cutoff doesn't work for your dataset
#vcfR@gt <- vcfR@gt[,colnames(vcfR@gt) != "KVO248_H_dinops_Isabel"]
```

```{r}
#drop invariant sites plus singletons for plotting
vcf.filt<-min_mac(vcfR, min.mac = 2)
#assess the effect of missing data on clustering inferences
assess_missing_data_tsne(vcf.filt, popmap = popmap, thresholds =c(.7,.8,.9, 1), clustering = FALSE)
#do we need to drop samples more aggressively?
#which filtering threshold adequately removes missing data to allow objective clustering?
#Samples at the high end of missing data cutoffs are not clustering correctly and dragging this whole enterprise down
#let's set a better cutoff
vcfR<-missing_by_sample(vcfR=vcfR, cutoff = .75)
```

## Step 3: Set the arbitrary missing data cutoff
### We can visualize the effect that typical missing data cutoffs will have on both the number of SNPs retained and the total missing data in our entire dataset.
### We want to choose a cutoff that minimizes the overall missing data in the dataset, while maximizing the total number of loci retained.
### Clustering analyses above show that .7, .8, and .9 all seem to allow samples to cluster reasonably
```{r}
#visualize missing data by SNP and the effect of various cutoffs on the missingness of each sample
missing_by_snp(vcfR)
#choose a value that retains an acceptable amount of missing data in each sample, and maximizes SNPs retained while minimizing overall missing data, and filter vcf
vcfR<-missing_by_snp(vcfR, cutoff = .9)
```


check once more to see how many SNPs and individuals remain compared to our original, unfiltered vcf
```{r}
#use this function to remove loci that have become invariant during our filtering procedure plus singletons which don't contribute to phylogenetic signal
vcfR<-min_mac(vcfR, min.mac = 2)
#check the number of loci retained
vcfR
#plot depth per snp and per sample
dp <- extract.gt(vcfR, element = "DP", as.numeric=TRUE)
heatmap.bp(dp, rlabels = FALSE)

#plot genotype quality per snp and per sample
gq <- extract.gt(vcfR, element = "GQ", as.numeric=TRUE)
heatmap.bp(gq, rlabels = FALSE)
```

### We can filter for linkage (one SNP per locus) and use the convenient function 'write.vcf' from vcfR to export our filtered vcf file for downstream analyses
```{r}
#write out the filtered vcf file
#write.vcf(vcfR, file = "~/Desktop/hipposideros/filtered.vcf.gz")
#filter to one SNP per locus to get an unlinked dataset
unlinked.vcf<-distance_thin(vcfR, min.distance = 10000)
#write out vcf file of unlinked SNPs
#write.vcf(unlinked.vcf, file = "~/Desktop/hipposideros/unlinked.filtered.vcf.gz")
```